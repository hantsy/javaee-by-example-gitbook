# Activating CDI in JSF 2.3

When I upgraed [my Java EE 7 sample](https://github.com/hantsy/ee7-sandbox) to the newest Java EE 8, the first thing confused me is the CDI beans are not recoganized in Facelects template in a JSF 2.3 based web applicaiton, which is working in the development version, but in the final release version, they are always resolved as null. I filed an issue on [Mojarra](https://github.com/javaserverfaces/mojarra) and [discussed it](https://github.com/javaserverfaces/mojarra/issues/4264) with the developers from communities and the JSF experts. 

According to  the content of  [README](https://github.com/javaserverfaces/mojarra), In a JSF 2.3 application, to activate CDI support, declaring a 2.3 versioned *faces-config.xml* and adding `javax.faces.ENABLE_CDI_RESOLVER_CHAIN` in web.xml is not enough, you have to declare `@FacesConfig` annotated class to enable CDI.

Here is the steps I created a workable JSF 2.3 applicatoin in Java EE 8.

1. Create a Java web application, this can be done easily by NetBeans IDE,  or generated by Maven archetype, for exmaple.
    
    ```
	$ mvn archetype:generate -DgroupId=com.example
	-DartifactId=demo
	-DarchetypeArtifactId=maven-archetype-webapp
	-DinteractiveMode=false 
	```
		
2. Add `javaee-api` in project dependencies. 

	```xml
	<properties>
	  <version.javaee-api>8.0</version.javaee-api>
	  ...// other properties
	</properties>
	<dependencyManagement>
	  <dependencies>
		  <dependency>
			  <groupId>javax</groupId>
			  <artifactId>javaee-api</artifactId>
			  <version>${version.javaee-api}</version>
			  <scope>provided</scope>
		  </dependency>
		  ...//other dependencies
	   </dependencies>  
	</dependencyManagement>
	<dependencies>
	   <dependency>
		  <groupId>javax</groupId>
		  <artifactId>javaee-api</artifactId>
	   </dependency>
	   ...//other dependencies
	</dependencies>
	```

3. Add a *faces-config.xml* into *WEB-INF* folder, it is optional in JSF 2.3.
   â€‹ 
	```xml
	<?xml version='1.0' encoding='UTF-8'?>
	<faces-config xmlns="http://xmlns.jcp.org/xml/ns/javaee"
		  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
		  xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-facesconfig_2_3.xsd"
		  version="2.3">
	</faces-config>
	```	

4. Declare a *beans.xml*, CDI is enabled by default in Java EE 7, so it  is optional.

	```xml
	<?xml version="1.0" encoding="UTF-8"?>
	<beans xmlns="http://xmlns.jcp.org/xml/ns/javaee"
		   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
		   xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/beans_2_0.xsd"
		   bean-discovery-mode="all" 
		   version="2.0">
	</beans>
	```

5. Add *web.xml*. It is not required by JSF, but you can customize the application by some properties.

	```xml
	<?xml version="1.0" encoding="UTF-8"?>
	<web-app xmlns="http://xmlns.jcp.org/xml/ns/javaee"
			 xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
			 xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd"
			 version="4.0">
		<context-param>
			<param-name>javax.faces.FACELETS_REFRESH_PERIOD</param-name>
			<param-value>0</param-value>
		</context-param>
   
		<context-param>
			<param-name>javax.faces.PROJECT_STAGE</param-name>
			<param-value>Development</param-value>
		</context-param>
   
		<context-param>
			<param-name>javax.faces.validator.ENABLE_VALIDATE_WHOLE_BEAN</param-name>
			<param-value>true</param-value>
		</context-param>
   
		<context-param>
			<param-name>javax.faces.ENABLE_CDI_RESOLVER_CHAIN</param-name>
			<param-value>true</param-value>
		</context-param>
   
		<context-param>
			<param-name>javax.faces.ENABLE_WEBSOCKET_ENDPOINT</param-name>
			<param-value>true</param-value>
		</context-param> 
   
		<!--    <context-param>
			<param-name>javax.faces.DISABLE_FACESSERVLET_TO_XHTML</param-name>
			<param-value>true</param-name>
		</context-param>-->
	</web-app>
	```
		
   JSF 2.3 provides some options to activate the new features added in 2.3.

   * `ENABLE_VALIDATE_WHOLE_BEAN` is used to enable class level Bean validation       
   * `ENABLE_WEBSOCKET_ENDPOINT` is used to enable websocket support  
   * `ENABLE_CDI_RESOLVER_CHAIN` is orginally designed for enabling CDI, but it seems it is replaced by `@FacesConfig`
   * `DISABLE_FACESSERVLET_TO_XHTML` will disable JSF servelt mapping to \*.xhtml. By default, JSF Servlet will serve *\*.xhtml*.

6. Declare a `@FacesConfig` annotated class to activate CDI in JSF 2.3.

  ```java
   @FacesConfig(
   // Activates CDI build-in beans
   version = JSF_2_3 
   )
   public class ConfigurationBean {

   }
  ```

Done.

Another question still confused me and other developers, as the codes shown above, we use *all* bean-discovery-mode in the *beans.xml*. If we used *annotated* here, we have to add `@FacesConfig` to every CDI backing beans.  

